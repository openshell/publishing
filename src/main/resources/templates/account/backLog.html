<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <title>任务发布系统</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
    <link rel="stylesheet" href="/webjars/bootstrap/3.3.7-1/css/bootstrap.min.css"/>
    <!-- 引入时间插件-->
    <link rel="stylesheet" type="text/css"
          href="/css/bootstrap-datetimepicker.css"
          media="all"/>

    <!-- 插件使用的样式表文件 -->
    <link rel="stylesheet" href="/css/selectpage.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css" type="text/css">
</head>
<body class="app sidebar-mini rtl">

<header class="app-header">
    <a class="app-header__logo" href="${APP_PATH }/emp/adminHome"> <i
            class="fa fa-home"></i> 任务分发系统
    </a>
    <a class="app-sidebar__toggle" href="/user/logout" data-toggle="sidebar"
       aria-label="Hide Sidebar"></a>
    <ul class="app-nav">
        <a class="app-nav__item" href="/user/logout" >退出</a>
    </ul>
</header>

<div class="app-sidebar__overlay" data-toggle="sidebar"></div>

<aside class="app-sidebar">
    <div class="app-sidebar__user">
        <img class="app-sidebar__user-avatar"
             src="/img/admin.png" alt="User Image">
        <div>
            <p class="app-sidebar__user-name">
                <shiro:user>
                    <shiro:principal/>
                </shiro:user>
            </p>

            </p>

        </div>
    </div>
    <ul class="app-menu">
        <li><a class="app-menu__item active"
               href="/task/toBackLog"><i
                class="app-menu__icon fa fa-dashboard"></i><span
                class="app-menu__label">待办任务</span></a>
        </li>
        <li><a class="app-menu__item"
               href="/task/toAllTask"><i
                class="app-menu__icon fa fa-users"></i><span
                class="app-menu__label">所有任务</span></a>
        </li>
        <li><a class="app-menu__item" href="/user/toAllUser"><i
                class="app-menu__icon fa fa-users"></i><span
                class="app-menu__label">人员列表</span></a>
        </li>
    </ul>
</aside>
<!-- 搭建显示页面 -->
<main class="app-content">
    <div class="tile">

 <!--   办理任务模态框模态框-->
        <div class="modal fade" id="TaskDealModal" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel">办理任务</h4>
                        <button type="button" class="close" data-dismiss="modal"
                                aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>

                    </div>
                    <div class="modal-body">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">名称</label>
                                <div class="col-sm-10">
                                    <input type="text" name="taskName" class="form-control"
                                           id="taskName_deal" readonly="readonly"> <span
                                        class="help-block"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">任务类型</label>
                                <div class="col-sm-10">
                                    <label class="radio-inline">
                                        <input type="radio" name="taskType"  value="claim"
                                                                        checked="checked" readonly="readonly"> 认领制
                                    </label> <label class="radio-inline"> <input type="radio"
                                                                                 name="taskType"  value="coordinate" readonly="readonly"> 协同制
                                </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">负责人</label>
                                <div class="col-sm-10">
                                    <input type="text" name="taskCharge_deal" class="form-control"
                                           id="taskCharge_deal" readonly="readonly"> <span
                                        class="help-block"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">说明</label>
                                <div class="col-sm-10">
                                    <textarea class="form-control" name="taskDescription_deal" rows="5"id="taskDescription_deal"  placeholder="任务描述"></textarea>
                                    <span
                                            class="help-block"></span>
                                </div>
                                <input type="hidden" name="taskId_deal"  id="taskId_deal" >
                                <input type="hidden" name="userId"  id="userId" th:value="${session.loginUser.userId}" >
                            </div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="task_update_btn">办理完成</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-md-5 pl-1 pr-1">
                <div class="navbar-form navbar-left pl-2" role="search">
                    <div class="form-group">
                        时间检索:
                        <div class="input-group date col-xs-4" id="yyyy_mm_dd">
                            <input name="regDate" class="form-control input-sm" type="text" value="" readonly="readonly"> <span
                                class="input-group-addon" style="opacity: 0.8;"> <span
                                class="glyphicon glyphicon-remove"></span>
									</span>
                        </div>
                        至
                        <div class="input-group date col-xs-4" id="yyyy_mm_dd2">
                            <input name="regDate" class="form-control input-sm" type="text" value="" readonly="readonly"> <span
                                class="input-group-addon" style="opacity: 0.8;"> <span
                                class="glyphicon glyphicon-remove"></span>
									</span>
                        </div>
                        <button class="btn btn-primary btn-sm" >查询</button>
                    </div>

                </div>
            </div>
            <div class="col-md-3 pl-1 pr-1">
                <div class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input type="text" class="form-control form-custom input-sm" id="searchKey" placeholder="任务名称检索">
                    </div>
                    <button class="btn btn-primary btn-sm" id="searchByName">搜索</button>
                </div>
            </div>

        </div>

    <!-- 显示表格数据 -->
        <div class="row">
            <div class="col-md-12">
                <table class="table table-hover" id="task_table">
                    <thead>
                    <tr>
                        <th>序号</th>
                        <th>任务名称</th>
                        <th>类型</th>
                        <th>负责人</th>
                        <th>发布日期</th>
                        <th>操作</th>

                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

    <!-- 显示分页信息 -->
    <div class="row">
        <!--分页文字信息  -->
        <div class="col-md-6" id="page_info_area"></div>
        <!-- 分页条信息 -->
        <div class="col-md-6" id="page_nav_area"></div>
    </div>


</main>


<script src="/webjars/jquery/3.1.1/jquery.min.js"></script>
<script src="/webjars/bootstrap/3.3.7-1/js/bootstrap.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/bootstrap-datetimepicker.min.js"></script>
<script src="/js/bootstrap-datetimepicker.zh-CN.js"></script>
<script src="/js/bulid.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<!-- 下拉分页插件核心脚本 -->
<script src="/js/selectpage.js"></script>
<script type="text/javascript">
    var totalRecord;
    var userId=$("#userId").val();
    $(function () {

        to_back_page(1);
        newBackLogNotice();
        toastr.options = {
            closeButton: false,  	//是否显示关闭按钮（提示框右上角关闭按钮）。
            debug: false,  			//是否为调试。
            progressBar: true,  	//是否显示进度条（设置关闭的超时时间进度条）
            positionClass: "toast-top-right",  	//消息框在页面显示的位置
            onclick: function() { alert("!!"); },  		//点击消息框自定义事件
            showDuration: "300",  	//显示动作时间
            hideDuration: "1000",  	//隐藏动作时间
            timeOut: "2000",  		//自动关闭超时时间
            extendedTimeOut: "1000",
            showEasing: "swing",
            hideEasing: "linear",
            showMethod: "fadeIn",  	//显示的方式，和jquery相同
            hideMethod: "fadeOut"  	//隐藏的方式，和jquery相同
            //等其他参数
        };
    });

    function to_back_page(pn) {
        $.ajax({
            url: "/task/allBackLog?userId="+userId,
            data: "pageNum=" + pn,
            type: "GET",
            success: function (result) {
                console.log(result);
                bulid_page_table(result);
                bulid_page_info(result);
                bulid_page_nav(result)
            }
        });
    }

    function bulid_page_table(result) {
        $("#users_table tbody").empty();
        var users = result.extend.pageInfo.list;
        var status=null;
        $.each(users, function (index, item) {
            var taskId = $("<td></td>").append(item.taskId);
            var taskName = $("<td></td>").append(item.taskName);
            var taskType = $("<td></td>").append(item.taskType);
            var taskCharge = $("<td></td>").append(item.taskCharge);
            var formatTaskStartTime = $("<td></td>").append(item.formatTaskStartTime);
            var editBtn =$("<button></button>").addClass("btn btn-info").append("办理");
            editBtn.attr("edit-id", item.taskId);
            var taskStatus = $("<td></td>").append(status);
            var btnTd = $("<td></td>").append(editBtn);
            $("<tr></tr>").append(taskId).append(taskName).append(taskType).append(taskCharge)
                .append(formatTaskStartTime).append(taskStatus).append(btnTd).appendTo("#task_table tbody");
        });
    }
    //解析显示分页信息
    function bulid_page_info(result) {
        $("#page_info_area").empty();
        $("#page_info_area").append(
            "当前第" + result.extend.pageInfo.pageNum + "页,总"
            + result.extend.pageInfo.pages + "页,总"
            + result.extend.pageInfo.total + "条记录");
        totalRecord = result.extend.pageInfo.total;
        currentPage = result.extend.pageInfo.pageNum;
    }

    function bulid_page_nav(result) {
        //page_nav_area
        $("#page_nav_area").empty();
        var ul = $("<ul></ul>").addClass("pagination");

        //构建元素
        var firstPageLi = $("<li></li>").append(
            $("<a></a>").append("首页").attr("href", "#"));
        var prePageLi = $("<li></li>").append(
            $("<a></a>").append("&laquo;"));
        if (result.extend.pageInfo.hasPreviousPage == false) {
            firstPageLi.addClass("disabled");
            prePageLi.addClass("disabled");
        } else {
            //为元素添加点击翻页的事件
            firstPageLi.click(function () {
                to_back_page(1);
            });
            prePageLi.click(function () {
                to_back_page(result.extend.pageInfo.pageNum - 1);
            });
        }

        var nextPageLi = $("<li></li>").append(
            $("<a></a>").append("&raquo;"));
        var lastPageLi = $("<li></li>").append(
            $("<a></a>").append("末页").attr("href", "#"));
        if (result.extend.pageInfo.hasNextPage == false) {
            nextPageLi.addClass("disabled");
            lastPageLi.addClass("disabled");
        } else {
            nextPageLi.click(function () {
                to_back_page(result.extend.pageInfo.pageNum + 1);
            });
            lastPageLi.click(function () {
                to_back_page(result.extend.pageInfo.pages);
            });
        }

        //添加首页和前一页 的提示
        ul.append(firstPageLi).append(prePageLi);
        //1,2，3遍历给ul中添加页码提示
        $.each(result.extend.pageInfo.navigatepageNums, function (index,
                                                                  item) {

            var numLi = $("<li></li>").append($("<a></a>").append(item));
            if (result.extend.pageInfo.pageNum == item) {
                numLi.addClass("active");
            }
            numLi.click(function () {
                to_back_page(item);
            });
            ul.append(numLi);
        });
        //添加下一页和末页 的提示
        ul.append(nextPageLi).append(lastPageLi);

        //把ul加入到nav
        var navEle = $("<nav></nav>").append(ul);
        navEle.appendTo("#page_nav_area");

    }

    $("#regSearch").click(function(){
        var  pn=1;
        $.ajax({
            url:"/task/searchByName?searchKey="+$("#searchKey").val()+"pageNum=" + pn,
            type:"GET",
            success:function(result){
                bulid_page_table(result);
                bulid_page_info(result);
                bulid_page_nav(result)
            }
        });
    });

    //办理模态框
    $(document).on("click", ".btn-info", function() {
        getTask($(this).attr("edit-id"))
        // $("#task_edit_btn").attr("edit_id",$(this).attr("edit-id"));
        $("#TaskDealModal").modal({
            backdrop : "static"
        });
    });

    $("#task_update_btn").click(function(){
        $.ajax({
            url:"/task/updateTask",
            type:"GET",
            data:"taskId="+$("#taskId_deal").val()+"&taskDescription="+$("#taskDescription_deal").val()+"&userId="+userId,
            success:function (result) {
                console.log(result);

                if (result.code == 100) {
                    alert(result.msg);

                    //1、关闭模态框
                    $("#taskClaimModal").modal('hide');
                }
                else if(result.code==200){
                    console.log(result)
                    alert(result.extend.errorInfo);
                }
            }
        });
    });
    //根据taskId 获取任务请求
    function getTask(taskId) {
        $.ajax({
            url : "/task/getById?taskId=" + taskId,
            type : "GET",
            success : function(result) {
                console.log(result);
                var taskDate = result.extend.task;
                $("#taskName_deal").val(taskDate.taskName);

                $("#taskCharge_deal").val(taskDate.taskCharge);
                $("#taskDealModal input[name=taskType]").val([taskDate.taskType]);
                $("#taskId_deal").val(taskDate.taskId);
                $("#taskDescription_claim").val(taskDate.taskDescription);


            }
        });
    }

    function newBackLogNotice(){
        $.ajax({
            url:"/task/getBacklogNum",
            type:"GET",
            data:"userId="+userId,
            success:function(result){
                console.log(result);
                toastr.warning('您有'+result.extend.backlogNum+"条可以领取的任务");
            }
        });

    }
</script>

</body>
</html>